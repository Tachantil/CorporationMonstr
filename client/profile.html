<!DOCTYPE html>
<html lang="uk">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–æ—Ñ—ñ–ª—å ‚Äî –ö–æ—Ä–ø–æ—Ä–∞—Ü—ñ—è –ú–æ–Ω—Å—Ç—Ä—ñ–≤</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="profile.css" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&family=Inter:wght@700&display=swap" rel="stylesheet">
</head>

<body>

  <header>
    <a href="index.html" class="logo">
      <img src="pictures/–ª–æ–≥–æ.png" alt="–ö–æ—Ä–ø–æ—Ä–∞—Ü—ñ—è –º–æ–Ω—Å—Ç—Ä—ñ–≤" />
      <span class="site-title">–ö–æ—Ä–ø–æ—Ä–∞—Ü—ñ—è –º–æ–Ω—Å—Ç—Ä—ñ–≤</span>
    </a>
    <div class="user-profile">
      <input type="text" placeholder="üîç –ü–æ—à—É–∫..." />
      <img src="pictures/photo-user.png" alt="User" id="userAvatar"/>
    </div>
  </header>

  <div class="profile-container">
    <h1>üë§ –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</h1>
    <div class="profile-card">
      <img src="pictures/photo-user.png" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar" id="avatarPreview" />
      <div class="profile-info">
        <form id="profileForm">
          <label>–Ü–º'—è:<br><input type="text" name="name" value="–ú–∞–π–∫ –í–∞–∑–æ–≤—Å—å–∫–∏–π" required></label><br>
          <label>Email:<br><input disabled type="email" name="email" value="mike@monstersinc.com" required></label><br>
          <label>–ü–æ—Å–∞–¥–∞:<br><input type="text" name="role" value="–°—Ç—Ä–∞—Ö–æ–ø—Ä–∞–∫—Ç–∏–∫–∞–Ω—Ç"></label><br>
          <label>–†—ñ–≤–µ–Ω—å –∂–∞—Ö—É (%):<br><input type="number" name="scare" value="87" min="0" max="100"></label><br><br>

          <label>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–æ–≤–∏–π –∞–≤–∞—Ç–∞—Ä:<br>
            <input type="file" id="avatarInput" accept="image/*">
          </label><br><br>

          <button type="submit">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById('profileForm');

      const user = JSON.parse(localStorage.getItem("user"))
      const avatar = document.getElementById('avatarPreview')
      const avatarImg = document.getElementById('userAvatar')


      if (user) {
        form.name.value = user.name || '';
        form.email.value = user.email || '';
        form.role.value = user.role || '';
        form.scare.value = user.scare || '';

        if (user.avatar) {
          avatar.src = user.avatar;
          avatarImg.src = user.avatar;
        }
      }
    })

    document.getElementById("profileForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = e.target;

      let obj = {
        'name': form.name.value,
        'email': form.email.value,
        'role': form.role.value,
        'scare': form.scare.value,
      }


      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
      const avatarFile = document.getElementById('avatarInput').files[0];

      if (avatarFile) {
        const toBase64 = file => new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file); // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ base64 —Å—Ç—Ä–æ–∫—É
          reader.onload = () => resolve(reader.result); // –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏
          reader.onerror = error => reject(error);
        });

        const base64String = await toBase64(avatarFile);
        obj.avatar = base64String; // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±—ä–µ–∫—Ç
      }

      localStorage.setItem("user", JSON.stringify(obj))

      await fetch("http://localhost:4252/update_profile", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(obj)
      })
    });

    document.getElementById("avatarInput").addEventListener("change", function (event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = (e) => document.getElementById("avatarPreview").src = e.target.result;
      if (file) reader.readAsDataURL(file);
    });
  </script>

</body>

</html>